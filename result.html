<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Follower Chain</title>
    <script>
        async function fetchFollowers(username) {
            try {
                const response = await fetch(`https://api.scratch.mit.edu/users/${username}/followers`);
                if (!response.ok) {
                    console.error(`Error fetching followers for ${username}`);
                    return [];
                }
                return await response.json();
            } catch (error) {
                console.error("Error fetching followers:", error);
                return [];
            }
        }

        async function fetchFollowerChain(start, end, findAll) {
            let queue = [[start]]; // Queue of chains to process
            let visited = new Set(); // Track visited users
            let allChains = []; // Store all possible chains

            while (queue.length > 0) {
                let currentChain = queue.shift();
                let currentUser = currentChain[currentChain.length - 1];

                if (visited.has(currentUser)) continue;
                visited.add(currentUser);

                const followers = await fetchFollowers(currentUser);
                if (followers.length === 0) continue;

                for (let follower of followers) {
                    let newChain = [...currentChain, follower.username];

                    if (follower.username.toLowerCase() === end.toLowerCase()) {
                        allChains.push(newChain);
                        if (!findAll) {
                            displayChains(allChains);
                            return; // Stop if we only need one path
                        }
                    } else {
                        queue.push(newChain);
                    }
                }
            }

            displayChains(allChains);
        }

        function displayChains(chains) {
            const resultDiv = document.getElementById('result');
            if (chains.length === 0) {
                resultDiv.innerHTML = "<h2>No valid chains found.</h2>";
                return;
            }

            let chainHTML = "<h2>Follower Chains:</h2><ul>";
            for (let chain of chains) {
                chainHTML += `<li>${chain.join(' â†’ ')}</li>`;
            }
            chainHTML += "</ul>";
            resultDiv.innerHTML = chainHTML;
        }

        function startChain() {
            const params = new URLSearchParams(window.location.search);
            const startUser = params.get('start');
            const endUser = params.get('end');
            const findAll = params.get('all') === "1"; // Check if "all=1" is in the URL

            if (startUser && endUser) {
                fetchFollowerChain(startUser, endUser, findAll);
            } else {
                alert('Please provide both start and end parameters in the URL.');
            }
        }

        window.onload = startChain;
    </script>
</head>
<body>
    <h1>Scratch Follower Chain</h1>
    <div id="result"></div>
</body>
</html>
